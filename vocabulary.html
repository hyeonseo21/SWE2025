<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EnPick - TOEIC Vocabulary</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/vocabulary.css">
  <link rel='stylesheet' type='text/css'href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css'/>
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <nav class="nav-bar">
    <div class="nav-logo">
      <img src="assets/enpick-logo.png" alt="EnPick ë¡œê³ " />
      <h2>EnPick</h2>
    </div>
    <div class="nav-user">
      <a href="#" id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <div class="hamburger" id="hamburger">&#9776;</div>
  </nav>

  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <a href="home.html" class="menu-item">í™ˆ</a>
    <a href="vocabulary.html" class="menu-item active">ì „ì²´ ë‹¨ì–´ì¥</a>
    <a href="mywords.html" class="menu-item">My ë‹¨ì–´ì¥</a>
    <a href="study.html" class="menu-item">í•™ìŠµ</a>
    <a href="gamestart.html" class="menu-item">ë‹¨ì–´ ë¯¸ë‹ˆ ê²Œì„</a>
    <a href="teststart.html" class="menu-item">í…ŒìŠ¤íŠ¸</a>
    <a href="#" class="menu-item">í†µê³„</a>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="main-content">
    <h1>ë‹¨ì–´ì¥</h1>

    <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
    <div class="search-section">
      <div class="search-box">
        <div class="search-input-wrapper">
          <input type="text" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="searchInput" />
        </div>
        <select id="filterDifficulty"> <!-- ì¶”ê°€ëœ ë‚œì´ë„ í•„í„° -->
          <option value="all">ì „ì²´ ë‚œì´ë„</option>
          <option value="800">800</option>
          <option value="700">700</option>
          <option value="600">600</option>
        </select>
        <select id="filterType">
          <option value="all">ì „ì²´ í’ˆì‚¬</option>
          <option value="noun">ëª…ì‚¬</option>
          <option value="verb">ë™ì‚¬</option>
          <option value="adjective">í˜•ìš©ì‚¬</option>
          <option value="adverb">ë¶€ì‚¬</option>
        </select>
      </div>
    </div>

    <!-- ë‹¨ì–´ ëª©ë¡ í…Œì´ë¸” -->
    <div class="word-table">
      <table>
        <thead>
          <tr>
            <th>ë‚œì´ë„</th>
            <th>ë‹¨ì–´</th>
            <th>í’ˆì‚¬</th>
            <th>ì˜ë¯¸</th>
            <th>í•™ìŠµ ìƒíƒœ</th>
            <th>í•™ìŠµí•˜ê¸°</th>
          </tr>
        </thead>
        <tbody id="wordTableBody">
          <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„±ë  ë¶€ë¶„ -->
        </tbody>
      </table>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="pagination">
      <button>&lt;</button>
      <button class="active">1</button>
      <button>2</button>
      <button>3</button>
      <button>&gt;</button>
    </div>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    let wordData = [];
    let filteredWords = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let learnedSet = new Set();
    const userId = localStorage.getItem('user_id');

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¨ì–´ ëª©ë¡ í‘œì‹œ
    document.addEventListener('DOMContentLoaded', async () => {

      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ì„¸ì…˜ ê¸°ë°˜)
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (!res.ok) throw new Error();
        const user = await res.json();

        // ì˜ˆì‹œë¡œ ì‚¬ìš©ì ì´ë©”ì¼ í‘œì‹œ
        const userSpan = document.createElement('span');
        userSpan.textContent = `${user.email}ë‹˜`;
        document.querySelector('.nav-user')?.prepend(userSpan);

        if (user.role === 'admin') {
          const adminBtn = document.createElement('a');
          adminBtn.href = 'admin.html';
          adminBtn.className = 'logout-btn';
          adminBtn.textContent = 'ê´€ë¦¬ì í˜ì´ì§€';
          document.querySelector('.nav-user')?.prepend(adminBtn);
        }

      } catch (err) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
      }

      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
          await fetch('/logout', {
            method: 'POST',
            credentials: 'include'
          });
        } catch (err) {
          console.error('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', err);
        }

        // localStorage ì •ë³´ ì‚­ì œ
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('userRole');

        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = 'login.html';
      });


      // Word.txt íŒŒì¼ì—ì„œ ë°ì´í„° ì½ì–´ì˜¤ê¸°
      // DBì—ì„œ ë‹¨ì–´ ëª©ë¡ ì½ì–´ì˜¤ê¸° (API í˜¸ì¶œ)
      try {
        const response = await fetch('/api/words', {credentials: 'include'});
        const json = await response.json();
        wordData = json;
        filteredWords = [...wordData];
        displayPage(currentPage);
      } catch (error) {
        console.error('ë‹¨ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
        document.getElementById('wordTableBody').innerHTML = 
          '<tr><td colspan="4">ë‹¨ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</td></tr>';
      }

      let learnedSet = new Set(); // í•™ìŠµ ì™„ë£Œ ë‹¨ì–´ id ì €ì¥

      const userId = localStorage.getItem('user_id');

      if (userId) {
        try {
          const learnedRes = await fetch(`/api/learned?user_id=${userId}`);
          const learnedIds = await learnedRes.json();
          learnedSet = new Set(learnedIds);
        } catch (err) {
          console.error('í•™ìŠµ ì™„ë£Œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
        }
      }

    });

    // ë‹¨ì–´ ëª©ë¡ í‘œì‹œ í•¨ìˆ˜
    function displayWords(words) {
      const tableBody = document.getElementById('wordTableBody');
      tableBody.innerHTML = ''; // í…Œì´ë¸” ì´ˆê¸°í™”

      words.forEach(word => {
        const row = createWordRow(word);
        tableBody.appendChild(row);
      });
    }

    //ë‹¨ì–´ í–‰ ìƒì„± í•¨ìˆ˜
    function createWordRow(word) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${word.difficulty}</td>
        <td>${word.word}</td>
        <td>${word.part_of_speech}</td>
        <td>${word.meaning}</td>
        <td>
          <div class="toggle-wrapper" data-id="${word.id}" data-checked="false">
            <div class="toggle-bg">
              <div class="toggle-handle"></div>
            </div>
            <i class="fa-solid fa-xmark toggle-icon"></i>
          </div>
        </td>
        <td>
          <button class="study-btn" onclick="showStudyOptions(${word.id})">í•™ìŠµí•˜ê¸°</button>
        </td>
      `;

      row.addEventListener('click', (e) => {
        if (e.target.classList.contains('study-btn') || e.target.classList.contains('study-sub-btn')) return;
        window.location.href = `seemore.html?wordId=${word.id}`;
      });

      const toggle = row.querySelector('.toggle-wrapper');
      const icon = toggle.querySelector('.toggle-icon');
      const isLearned = learnedSet.has(word.id);

      toggle.dataset.checked = isLearned.toString();
      if (isLearned) {
        toggle.classList.add('active');
        toggle.querySelector('.toggle-bg').style.backgroundColor = '#2ecc71';
        toggle.querySelector('.toggle-handle').style.left = '21px';
        icon.classList.remove('fa-xmark');
        icon.classList.add('fa-check');
      }

      toggle.addEventListener('click', async (e) => {
        e.stopPropagation();
        const checked = toggle.dataset.checked === 'true';
        const method = checked ? 'DELETE' : 'POST';

        const res = await fetch('/api/learned', {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, word_id: word.id })
        });

        if (res.ok) {
          const newChecked = !checked;
          toggle.dataset.checked = newChecked.toString();
          toggle.classList.toggle('active');
          icon.classList.toggle('fa-xmark', !newChecked);
          icon.classList.toggle('fa-check', newChecked);
          toggle.querySelector('.toggle-bg').style.backgroundColor = newChecked ? '#2ecc71' : '#ccc';
          toggle.querySelector('.toggle-handle').style.left = newChecked ? '21px' : '1px';
          if (newChecked) learnedSet.add(word.id);
          else learnedSet.delete(word.id);
        }
      });

      return row;
    }



    // í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜
    function displayPage(page) {
      currentPage = page;
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = filteredWords.slice(start, end);
      displayWords(pageItems);
      
      const totalPages = Math.ceil(filteredWords.length / itemsPerPage);
      updatePagination(page, totalPages);
    }
    
    function updatePagination(currentPage, totalPages) {
      const pagination = document.querySelector('.pagination');
      pagination.innerHTML = '';
      
      // ì´ì „ ë²„íŠ¼
      const prevButton = document.createElement('button');
      prevButton.textContent = 'âŸ¨';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
          displayPage(currentPage - 1);
        }
      });
      pagination.appendChild(prevButton);
      
      // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      
      if (startPage > 1) {
        pagination.appendChild(createPageButton(1));
        if (startPage > 2) pagination.appendChild(createEllipsis());
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pagination.appendChild(createPageButton(i));
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) pagination.appendChild(createEllipsis());
        pagination.appendChild(createPageButton(totalPages));
      }
      
      // ë‹¤ìŒ ë²„íŠ¼
      const nextButton = document.createElement('button');
      nextButton.textContent = 'âŸ©';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
          displayPage(currentPage + 1);
        }
      });
      pagination.appendChild(nextButton);
    }
    // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ì— ë°˜ì˜
    function createPageButton(pageNum) {
      const button = document.createElement('button');
      button.textContent = pageNum;
      button.classList.toggle('active', pageNum === currentPage);
      button.addEventListener('click', () => {
        currentPage = pageNum;
        displayPage(currentPage);
      });
      return button;
    }
    // í˜ì´ì§€ ë²ˆí˜¸ ë§ì„ë•Œ ... ìƒì„± í•¨ìˆ˜
    function createEllipsis() {
      const span = document.createElement('span');
      span.textContent = '...';
      span.style.margin = '0 8px';
      return span;
    }

    let openedStudyRow = null;

    function showStudyOptions(wordId) {
      // ê¸°ì¡´ ì—´ë¦° í–‰ ì œê±°
      if (openedStudyRow) {
        openedStudyRow.remove();
        openedStudyRow = null;
      }

      const row = Array.from(document.querySelectorAll('#wordTableBody tr')).find(r => {
        return r.querySelector('button.study-btn')?.getAttribute('onclick')?.includes(`${wordId}`);
      });

      if (!row) return;

      const studyRow = document.createElement('tr');
      studyRow.innerHTML = `
        <td colspan="6" style="text-align: left; padding: 10px;">
          <button class="study-sub-btn" onclick="window.location.href='seemore.html?wordId=${wordId}'">ğŸ” ìƒì„¸ë³´ê¸°</button>
          <button class="study-sub-btn" onclick="addToMyWords(${wordId})">MyWords ì¶”ê°€</button>
        </td>
      `;
      row.after(studyRow);
      openedStudyRow = studyRow;
    }
    
    // ê²€ìƒ‰ ê¸°ëŠ¥ ì„¤ì • í•¨ìˆ˜
    const searchInput = document.getElementById('searchInput');
    const filterType = document.getElementById('filterType');
    const filterDifficulty = document.getElementById('filterDifficulty');

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    searchInput.addEventListener('input', applyFilters);
    filterDifficulty.addEventListener('change', applyFilters);
    filterType.addEventListener('change', applyFilters);

    // í•„í„° í•¨ìˆ˜ ì •ì˜
    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const difficultyValue = filterDifficulty.value;
      const typeValue = filterType.value;

      filteredWords = wordData.filter(word => {
        const matchesSearch = word.word.toLowerCase().includes(searchTerm) || word.meaning.toLowerCase().includes(searchTerm);
        const matchesDifficulty = difficultyValue === 'all' || word.difficulty == parseInt(difficultyValue);
        const matchesType = typeValue === 'all' || word.part_of_speech === typeValue;

        return matchesSearch && matchesType && matchesDifficulty;
      });

      currentPage = 1;
      displayPage(currentPage);
    }

    async function addToMyWords(wordId) {
      const userId = localStorage.getItem('user_id');
      if (!userId) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
      }

      try {
        const res = await fetch('/api/mywords', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: userId,
            word_id: wordId,
            source: 'favorite'
          })
        });

        if (!res.ok) throw new Error();
        alert('My ë‹¨ì–´ì¥ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (err) {
        console.error('MyWords ì¶”ê°€ ì‹¤íŒ¨:', err);
        alert('ì´ë¯¸ ì¶”ê°€ëœ ë‹¨ì–´ì´ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    
    document.getElementById('hamburger')?.addEventListener('click', () => {
      document.querySelector('.sidebar')?.classList.toggle('show');
    });


  </script>
</body>
</html> 