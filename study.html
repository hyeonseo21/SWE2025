<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EnPick - ë‹¨ì–´ í•™ìŠµ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/study.css" />
</head>
<body>
  <nav class="nav-bar">
    <div class="nav-logo">
      <img src="assets/enpick-logo.png" alt="EnPick ë¡œê³ " />
      <h2>EnPick</h2>
    </div>
    <div class="nav-user">
      <span id="userEmail"></span>
      <a href="#" id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <div class="hamburger" id="hamburger">&#9776;</div>
  </nav>

  <div class="sidebar" id="sidebar">
    <a href="home.html" class="menu-item">í™ˆ</a>
    <a href="vocabulary.html" class="menu-item">ì „ì²´ ë‹¨ì–´ì¥</a>
    <a href="mywords.html" class="menu-item">My ë‹¨ì–´ì¥</a>
    <a href="study.html" class="menu-item active">í•™ìŠµ</a>
    <a href="gamestart.html" class="menu-item">ë‹¨ì–´ ë¯¸ë‹ˆ ê²Œì„</a>
    <a href="teststart.html" class="menu-item">í…ŒìŠ¤íŠ¸</a>
    <a href="#" class="menu-item">í†µê³„</a>
  </div>

  <main class="main-content study-content">
    <div class="study-header">
      <h2>ë‹¨ì–´ í•™ìŠµ</h2>
    </div>
    <div class="study-actions-inline">
        <button onclick="location.href='teststart.html'">í…ŒìŠ¤íŠ¸ ë°”ë¡œê°€ê¸°</button>
        <button onclick="location.href='gamestart.html'">ê²Œì„ ë°”ë¡œê°€ê¸°</button>
    </div>
    <div class="wordbook-toggle">
        <button id="btnAll" class="wordbook-btn active">ì „ì²´ ë‹¨ì–´ì¥</button>
        <button id="btnMy" class="wordbook-btn">My ë‹¨ì–´ì¥</button>
    </div>
    <div class="difficulty-filter" id="difficultyFilter" style="display:none;"></div>

    <div class="card-container">
      <div class="word-card" id="wordCard">
        <div class="card-inner" id="cardInner">
          <div class="card-front">
            <div class="card-word" id="cardWord">ë‹¨ì–´</div>
          </div>
          <div class="card-back">
            <div class="card-meaning" id="cardMeaning">ëœ»</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-controls-row">
          <button id="ttsUS">US ğŸ”Š</button>
          <button id="ttsUK">GB ğŸ”Š</button>
          <button id="ttsAU">AU ğŸ”Š</button>
        </div>
        <div class="card-controls-row">
          <button id="starBtn"> â˜† </button>
          <button id="detailBtn">ğŸ” ë‹¨ì–´ ìƒì„¸</button>
        </div>

    <div class="card-navigation">
      <button id="prevBtn">â† ì´ì „</button>
      <span id="progress">1 / 1</span>
      <button id="nextBtn">ë‹¤ìŒ â†’</button>
    </div>
  </main>

  <script>
    let words = [];
    let current = 0;
    let userId = null;
    let currentType = 'all';
    let diffButtonsInitialized = false;
    const selectedDiffs = new Set();

    const btnAll = document.getElementById('btnAll');
    const btnMy = document.getElementById('btnMy');
    const difficultyFilter = document.getElementById('difficultyFilter');

    document.addEventListener('DOMContentLoaded', async () => {
      // 1) ë¡œê·¸ì¸ ê²€ì‚¬
      try {
        const res = await fetch('/api/me');
        if (!res.ok) throw new Error();
        const { email, id } = await res.json();
        document.getElementById('userEmail').textContent = email;
        userId = id;
      } catch {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return window.location.href = 'login.html';
      }

      // 2) í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
      btnAll.addEventListener('click', () => {
        if (currentType === 'all') return;
        currentType = 'all';
        updateToggleUI();
        loadWords();
      });
      btnMy.addEventListener('click', () => {
        if (currentType === 'my') return;
        currentType = 'my';
        updateToggleUI();
        loadWords();
      });

      // 3) ë¡œê·¸ì•„ì›ƒ
      document.getElementById('logoutBtn').addEventListener('click', () => {
        fetch('/api/logout').then(() => location.href = 'login.html');
      });

      // 4) ì´ˆê¸° UI / ë°ì´í„° ë¡œë“œ
      updateToggleUI();
      loadWords();
    });

    // UI í† ê¸€ (ì „ì²´/My ëª¨ë“œ)
    function updateToggleUI() {
      btnAll.classList.toggle('active', currentType === 'all');
      btnMy.classList.toggle('active', currentType === 'my');
      difficultyFilter.style.display = (currentType === 'all') ? 'flex' : 'none';
    }

    // ë‹¨ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadWords() {
      const params = new URLSearchParams({ type: currentType });
      if (currentType === 'all' && selectedDiffs.size > 0) {
        selectedDiffs.forEach(d => params.append('difficulty', d));
      }

      const res = await fetch(`/api/words?${params.toString()}`);
      const data = await res.json();
      words = data;
      showWord(0);

      // ì²˜ìŒ ì „ì²´ ëª¨ë“œ ì§„ì… ì‹œì—ë§Œ ë‚œì´ë„ ë²„íŠ¼ ì´ˆê¸°í™”
      if (currentType === 'all' && !diffButtonsInitialized) {
        initDifficultyButtons(data);
      }
    }

    // ë‚œì´ë„ ë²„íŠ¼ ìƒì„± & ê¸°ë³¸ ì„ íƒ
    function initDifficultyButtons(data) {
      diffButtonsInitialized = true;
      difficultyFilter.innerHTML = '';
      selectedDiffs.clear();

      // ê³ ìœ  ë‚œì´ë„ ë¬¸ìì—´ ëª©ë¡ ì¶”ì¶œ
      const diffs = Array.from(new Set(data.map(w => String(w.difficulty))))
                        .sort();

      diffs.forEach(d => {
        selectedDiffs.add(d);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'difficulty-btn active';
        btn.textContent = d;

        btn.addEventListener('click', () => {
          const isActive = selectedDiffs.has(d);
          btn.classList.toggle('active', !isActive);
          if (isActive) selectedDiffs.delete(d);
          else selectedDiffs.add(d);
          loadWords();
        });

        difficultyFilter.appendChild(btn);
      });
    }

    // ì¹´ë“œì— ë‹¨ì–´Â·ì˜ë¯¸ í‘œì‹œ
    function showWord(idx) {
      const wordEl = document.getElementById('cardWord');
      const meaningEl = document.getElementById('cardMeaning');
      const progressEl = document.getElementById('progress');

      if (words.length === 0) {
        wordEl.textContent = 'ë‹¨ì–´ ì—†ìŒ';
        meaningEl.textContent = '';
        progressEl.textContent = '0 / 0';
        return;
      }
      const w = words[idx];

      const card = document.getElementById('wordCard');

      // 1. ìŠ¬ë¼ì´ë“œ ë°©í–¥ ê²°ì •
      const direction = (idx > current) ? 'slide-left' : 'slide-right';

      // 2. ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
      card.classList.remove('slide-left', 'slide-right');

      // 3. íŠ¸ë¦¬ê±°ìš© ì¬ë Œë”ë§
      void card.offsetWidth;  // ê°•ì œë¡œ reflow ë°œìƒ

      // 4. ìƒˆ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
      card.classList.add(direction);

      current = idx;
      wordEl.textContent = w.word;
      meaningEl.textContent = w.meaning;
      progressEl.textContent = `${idx + 1} / ${words.length}`;

      // ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ ìƒíƒœ
      starBtn.textContent = w.is_starred ? 'â˜…' : 'â˜†';
      starBtn.classList.toggle('active', Boolean(w.is_starred));
    }

    // ì¹´ë“œ í”Œë¦½
    document.getElementById('cardInner').addEventListener('click', () => {
      document.getElementById('cardInner').classList.toggle('flipped');
    });

    // ì´ì „/ë‹¤ìŒ
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (current > 0) showWord(current - 1);
      else showWord(words.length - 1);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (current < words.length - 1) showWord(current + 1);
      else showWord(0);
    });

    // ì¦ê²¨ì°¾ê¸° í† ê¸€
    document.getElementById('starBtn').addEventListener('click', () => {
      const w = words[current];
      const adding = !w.is_starred;
      fetch('/api/mywords', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: userId, word_id: w.id, source: 'favorite' })
      }).then(() => {
        w.is_starred = adding;
        document.getElementById('starBtn');
        starBtn.textContent = adding ? 'â˜…' : 'â˜†';
        starBtn.classList.toggle('active', adding);
      });
    });

    // ìƒì„¸ë³´ê¸° ë²„íŠ¼
    document.getElementById('detailBtn').addEventListener('click', () => {
      const w = words[current];
      location.href = `seemore.html?wordId=${encodeURIComponent(w.id)}`;
    });

    // ë°œìŒ ì¬ìƒ
    function playPron(region) {
      const text = words[current].word;
      const audio = new Audio(`/api/tts?text=${encodeURIComponent(text)}&region=${region}`);
      audio.onerror = () => {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = { us:'en-US', uk:'en-GB', au:'en-AU' }[region] || 'en-US';
        u.rate = 0.9;
        speechSynthesis.speak(u);
      };
      audio.play();
    }
    document.getElementById('ttsUS').addEventListener('click', () => playPron('us'));
    document.getElementById('ttsUK').addEventListener('click', () => playPron('uk'));
    document.getElementById('ttsAU').addEventListener('click', () => playPron('au'));

      // 1) ì»¨í…Œì´ë„ˆëŠ” í•œ ë²ˆë§Œ ì„ ì–¸
    const cardContainer = document.querySelector('.card-container');

    // 2) ê³µí†µ ìŠ¤ì™€ì´í”„ ì„ê³„ê°’
    const swipeThreshold = 50; // í„°ì¹˜/ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ëª¨ë‘ ì‚¬ìš©

    // 3) í„°ì¹˜ìš© ë³€ìˆ˜
    let touchStartX = 0;
    let touchEndX   = 0;

    // 4) ë§ˆìš°ìŠ¤ìš© ë³€ìˆ˜
    let isMouseDown = false;
    let mouseStartX = 0;
    let mouseEndX   = 0;

    // â”€â”€â”€ í„°ì¹˜ ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    cardContainer.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    });

    cardContainer.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe(touchEndX - touchStartX);
    });

    // â”€â”€â”€ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    cardContainer.addEventListener('mousedown', e => {
      isMouseDown = true;
      mouseStartX = e.clientX;
    });

    cardContainer.addEventListener('mousemove', e => {
      if (isMouseDown) mouseEndX = e.clientX;
    });

    cardContainer.addEventListener('mouseup', e => {
      if (!isMouseDown) return;
      isMouseDown = false;
      mouseEndX = e.clientX;
      handleSwipe(mouseEndX - mouseStartX);
    });

    // â”€â”€â”€ ê³µí†µ: ìŠ¤ì™€ì´í”„ ì²˜ë¦¬ í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function handleSwipe(diff) {
      if (Math.abs(diff) < swipeThreshold) return;
      if (diff > 0) {
        // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„/ë“œë˜ê·¸ â†’ ì´ì „ ì¹´ë“œ
        if (current > 0) showWord(current - 1);
        else showWord(words.length - 1);
      } else {
        // ì™¼ìª½ ìŠ¤ì™€ì´í”„/ë“œë˜ê·¸ â†’ ë‹¤ìŒ ì¹´ë“œ
        if (current < words.length - 1) showWord(current + 1);
        else showWord(0);
      }
    }

    document.getElementById('hamburger')?.addEventListener('click', () => {
      document.querySelector('.sidebar')?.classList.toggle('show');
    });
  </script>
</body>
</html>
