<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"> <!-- ë¬¸ì„œ ì¸ì½”ë”©ì„ UTF-8ë¡œ ì„¤ì • -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ëª¨ë°”ì¼ ë·°í¬íŠ¸ ì„¤ì • -->
    <title>ë‹¨ì–´ ìƒì„¸ - TOEIC Vocabulary</title> <!-- ë¸Œë¼ìš°ì € íƒ­ì— í‘œì‹œë  ì œëª© -->

    <!-- ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì—°ê²° -->
    <link rel="stylesheet" href="style.css"> <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="css/vocabulary.css"> <!-- ë‹¨ì–´ì¥ ê´€ë ¨ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="css/seemore.css"> <!-- ë‹¨ì–´ ìƒì„¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ -->
</head>
<body>
    <!-- ìƒë‹¨ ë°” -->
    <nav class="nav-bar">
        <div class="nav-logo">
            <img src="assets/enpick-logo.png" alt="EnPick ë¡œê³ " /> <!-- ë¡œê³  ì´ë¯¸ì§€ -->
            <h2>EnPick</h2> <!-- ë¡œê³  í…ìŠ¤íŠ¸ -->
        </div>
        <div class="nav-user">
            <!-- vocabulary.htmlê³¼ ë™ì¼í•œ ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì„ ìœ„í•´ idë¥¼ ì§€ì •í•˜ê³  href="#"ë¡œ ë³€ê²½ -->
            <a href="#" id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
        <div class="hamburger" id="hamburger">&#9776;</div>
    </nav>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <!-- ê° ë©”ë‰´ í•­ëª© -->
        <a href="home.html" class="menu-item">í™ˆ</a>
        <a href="vocabulary.html" class="menu-item">ì „ì²´ ë‹¨ì–´ì¥</a> <!-- í˜„ì¬ í˜ì´ì§€ ê°•ì¡° -->
        <a href="mywords.html" class="menu-item">My ë‹¨ì–´ì¥</a>
        <a href="#" class="menu-item">í•™ìŠµ</a>
        <a href="gamestart.html" class="menu-item">ë‹¨ì–´ ë¯¸ë‹ˆ ê²Œì„</a>
        <a href="teststart.html" class="menu-item">í…ŒìŠ¤íŠ¸</a>
        <a href="#" class="menu-item">í†µê³„</a>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="main-content">
        <h1>ë‹¨ì–´ ìƒì„¸</h1>
        <div class="word-detail">
            <!-- ë‹¨ì–´ ì œëª©ê³¼ í’ˆì‚¬ -->
            <div class="word-header">
              <div class="word-title-row">
                <h1 id="word-title">abide</h1>
                <div class="tts-buttons">
                  <button class="tts-btn" id="playUS">ğŸ‡ºğŸ‡¸ ğŸ”Š</button>
                  <button class="tts-btn" id="playUK">ğŸ‡¬ğŸ‡§ ğŸ”Š</button>
                  <button class="tts-btn" id="playAU">ğŸ‡¦ğŸ‡º ğŸ”Š</button>
                </div>
              </div>              
                <div id="word-info" class="word-info"></div> <!-- í’ˆì‚¬ í‘œì‹œ -->
            </div>

            <!-- ì˜ë¯¸ ì„¹ì…˜ -->
            <div class="meaning-section">
                <h2 class="meaning-title">ì˜ë¯¸</h2>
                <p id="meaning-content" class="meaning-content"></p> <!-- ì˜ë¯¸ í‘œì‹œ -->
            </div>

            <!-- ì˜ˆë¬¸ ì„¹ì…˜ -->
            <div class="meaning-section">
                <h2 class="meaning-title">ì˜ˆë¬¸</h2>
                <div class="example">
                  <div class="example-row">
                    <p id="example-en" class="example-text"></p>
                    <div class="tts-buttons" id="example-tts">
                      <button class="tts-btn" id="exampleUS">ğŸ‡ºğŸ‡¸ ğŸ”Š</button>
                      <button class="tts-btn" id="exampleUK">ğŸ‡¬ğŸ‡§ ğŸ”Š</button>
                      <button class="tts-btn" id="exampleAU">ğŸ‡¦ğŸ‡º ğŸ”Š</button>
                    </div>
                  </div>
                  <p id="example-ko" class="example-translation"></p> <!-- í•œê¸€ í•´ì„ -->
                </div>
            </div>

            <!-- ê´€ë ¨ ë‹¨ì–´ (ìœ ì˜ì–´/ë°˜ì˜ì–´) ì„¹ì…˜ -->
            <div class="meaning-section">
                <h2 class="meaning-title">ê´€ë ¨ ë‹¨ì–´</h2>
                <ul>
                    <li><strong>ìœ ì˜ì–´:</strong> <span id="synonym"></span></li> <!-- ìœ ì˜ì–´ -->
                    <li><strong>ë°˜ì˜ì–´:</strong> <span id="antonym"></span></li> <!-- ë°˜ì˜ì–´ -->
                </ul>
            </div>

            <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
            <button id="backBtn" class="back-button">ë’¤ë¡œê°€ê¸°</button>
            <button id="addMyWordsBtn" class="back-button">MyWords ì¶”ê°€</button>
        </div>
    </div>

    <!-- ë‹¨ì–´ ì •ë³´ ë¡œë“œ ë° ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ìš© ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      let isMyWords=false; // í˜„ì¬ ìƒíƒœ ì €ì¥ìš©
      let userId, wordId;

      document.addEventListener('DOMContentLoaded', async () => {
        // 1. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ì„¸ì…˜ ê¸°ë°˜)
        try {
          const res = await fetch('/api/me', { credentials: 'include' });
          if (!res.ok) throw new Error();
          const user = await res.json();
          userId=user.id;
          // ì‚¬ìš©ì ì´ë©”ì¼ í‘œì‹œ (ì„ íƒ ì‚¬í•­)
          const userSpan = document.createElement('span');
          userSpan.textContent = `${user.email}ë‹˜`;
          document.querySelector('.nav-user')?.prepend(userSpan);
        } catch (err) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = 'login.html';
          return;
        }

        // 2. ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥: vocabulary.htmlê³¼ ë™ì¼í•˜ê²Œ POST /logout í˜¸ì¶œ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        document.getElementById('logoutBtn')?.addEventListener('click', async () => {
          try {
            await fetch('/logout', {
              method: 'POST',
              credentials: 'include'
            });
          } catch (err) {
            console.error('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', err);
          }
          // localStorage ì„¸ì…˜ ì •ë³´ ì‚­ì œ (ìˆì„ ê²½ìš°)
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('userRole');
          window.location.href = 'login.html';
        });

        


        // 3. URL íŒŒë¼ë¯¸í„°ì—ì„œ ë‹¨ì–´ì˜ id (wordId) ì •ë³´ë¥¼ ê°€ì ¸ì˜´
        const params = new URLSearchParams(window.location.search);
        wordId = params.get('wordId');
        
        if (!wordId) {
          alert('ë‹¨ì–´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        try {
          // ê¸°ë³¸ ë‹¨ì–´ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ /api/wordsë¥¼ í˜¸ì¶œ í›„, í•´ë‹¹ wordIdì— ë§ëŠ” ë°ì´í„°ë¥¼ ì°¾ìŒ
          const wordsResponse = await fetch('http://localhost:3000/api/words');
          if (!wordsResponse.ok) throw new Error('ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          const words = await wordsResponse.json();
          const wordData = words.find(item => String(item.id) === wordId);
          if (!wordData) throw new Error('ë‹¨ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          
          // ìƒì„¸ ì •ë³´ëŠ” /api/details/:wordIdë¡œ ê°€ì ¸ì˜´ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
          let detailsData = { synonym: '', antonym: '', example: '', example_kor: '' };
          const detailsResponse = await fetch(`http://localhost:3000/api/details/${wordId}`);
          if (detailsResponse.ok) {
              detailsData = await detailsResponse.json();
          }
          
          // ì‘ë‹µ ë°›ì€ ë°ì´í„°ë¥¼ HTML ìš”ì†Œì— ì‚½ì…
          document.getElementById('word-title').textContent = wordData.word;
          document.getElementById('word-info').textContent = `[${wordData.part_of_speech}]`;
          document.getElementById('meaning-content').textContent = wordData.meaning;
          document.getElementById('example-en').textContent = detailsData.example || '';
          document.getElementById('example-ko').textContent = detailsData.example_kor || '';
          document.getElementById('synonym').textContent = detailsData.synonym || '';
          document.getElementById('antonym').textContent = detailsData.antonym || '';
          
        } catch (error) {
          console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
          alert('ë‹¨ì–´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        document.getElementById('backBtn').addEventListener('click', () => {
          window.history.back();
        });

        const addBtn = document.getElementById('addMyWordsBtn');

        const myRes = await fetch('/api/mywords?user_id=' + userId);
        const myList = await myRes.json();

        isMyWords = myList.some(item => String(item.word_id) === wordId);

        updateMyWordsBtn();
      });

      function playPronunciation(text, region) {
        const audio = new Audio(`/api/tts?text=${encodeURIComponent(text)}&region=${region}`);
        audio.onerror = () => {
          console.warn(`${region.toUpperCase()} TTS ì‹¤íŒ¨ â†’ SpeechSynthesis fallback`);
          const utter = new SpeechSynthesisUtterance(text);
          const langMap = { us: 'en-US', uk: 'en-GB', au: 'en-AU' };
          utter.lang = langMap[region] || 'en-US';
          utter.rate = 0.9;
          speechSynthesis.speak(utter);
        };
        audio.play();
      }

      document.getElementById('playUS')?.addEventListener('click', () => {
        const word = document.getElementById('word-title')?.textContent;
        if (word) playPronunciation(word, 'us');
      });
      document.getElementById('playUK')?.addEventListener('click', () => {
        const word = document.getElementById('word-title')?.textContent;
        if (word) playPronunciation(word, 'uk');
      });
      document.getElementById('playAU')?.addEventListener('click', () => {
        const word = document.getElementById('word-title')?.textContent;
        if (word) playPronunciation(word, 'au');
      });
      document.getElementById('exampleUS')?.addEventListener('click', () => {
        const sentence = document.getElementById('example-en')?.textContent;
        if (sentence) playPronunciation(sentence, 'us');
      });
      document.getElementById('exampleUK')?.addEventListener('click', () => {
        const sentence = document.getElementById('example-en')?.textContent;
        if (sentence) playPronunciation(sentence, 'uk');
      });
      document.getElementById('exampleAU')?.addEventListener('click', () => {
        const sentence = document.getElementById('example-en')?.textContent;
        if (sentence) playPronunciation(sentence, 'au');
      });

      
    document.getElementById('hamburger')?.addEventListener('click', () => {
      document.querySelector('.sidebar')?.classList.toggle('show');
    });

    document.getElementById('addMyWordsBtn').addEventListener('click', async () => {
      const endpoint = '/api/mywords';
      const method = isMyWords ? 'DELETE' : 'POST';

      const payload = {
        user_id: userId,
        word_id: wordId
      };

      if (!isMyWords) {
        // ì¶”ê°€í•  ë•Œë§Œ source í¬í•¨
        payload.source = 'favorite';
      }

      const res = await fetch(endpoint, {
        method,
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        isMyWords = !isMyWords;
        updateMyWordsBtn();
        alert(isMyWords ? 'MyWordsì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'MyWordsì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        alert('ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    function updateMyWordsBtn() {
      const btn = document.getElementById('addMyWordsBtn');
      if (!btn) return;
      btn.textContent = isMyWords
        ? 'MyWordsì—ì„œ ì‚­ì œ'
        : 'MyWordsì— ì¶”ê°€';
    }


    </script>
</body>
</html>
