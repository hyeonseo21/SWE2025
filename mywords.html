<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EnPick - My ë‹¨ì–´ì¥</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/vocabulary.css">
  <link rel='stylesheet' type='text/css'href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css'/>
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <nav class="nav-bar">
    <div class="nav-logo">
      <img src="assets/enpick-logo.png" alt="EnPick ë¡œê³ " />
      <h2>EnPick</h2>
    </div>
    <div class="nav-user">
      <a href="#" id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <div class="hamburger" id="hamburger">&#9776;</div>
  </nav>

  <!-- ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <a href="home.html" class="menu-item">í™ˆ</a>
    <a href="vocabulary.html" class="menu-item">ì „ì²´ ë‹¨ì–´ì¥</a>
    <a href="mywords.html" class="menu-item active">My ë‹¨ì–´ì¥</a>
    <a href="study.html" class="menu-item">í•™ìŠµ</a>
    <a href="gamestart.html" class="menu-item">ë‹¨ì–´ ë¯¸ë‹ˆ ê²Œì„</a>
    <a href="teststart.html" class="menu-item">í…ŒìŠ¤íŠ¸</a>
    <a href="#" class="menu-item">í†µê³„</a>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div class="main-content">
    <h1>My ë‹¨ì–´ì¥</h1>

    <div class="sort-filter">
      <div class="sort-group">
        <span>ì •ë ¬:</span>
        <button class="sort-btn active" data-sort="recent">ì¶”ê°€ì¼ìˆœ</button>
        <button class="sort-btn" data-sort="alpha">ì•ŒíŒŒë²³ìˆœ</button>
        <button class="sort-btn" data-sort="part">í’ˆì‚¬ìˆœ</button>
        <button id="sortDirectionBtn" class="sort-direction-btn">ì˜¤ë¦„ì°¨ìˆœ</button>
      </div>
      <div class="filter-group">
        <span>ë¶„ë¥˜:</span>
        <label>
          <input type="checkbox" class="filter-checkbox" value="favorite" checked>
          <i class="fa-solid fa-star added-icon" title="ìˆ˜ë™ ì¶”ê°€"></i>ìˆ˜ë™ ì¶”ê°€
        </label>
        <label>
          <input type="checkbox" class="filter-checkbox" value="test" checked>
          <i class="fa-solid fa-file-lines added-icon" title="í…ŒìŠ¤íŠ¸ ì˜¤ë‹µ"></i>í…ŒìŠ¤íŠ¸ ì˜¤ë‹µ
        </label>
        <label>
          <input type="checkbox" class="filter-checkbox" value="game" checked>
          <i class="fa-solid fa-gamepad added-icon" title="ê²Œì„ ì˜¤ë‹µ"></i>ê²Œì„ ì˜¤ë‹µ
        </label>
        <label>
          <input type="checkbox" class="filter-checkbox" value="learned">
          <i class="fa-solid fa-xmark toggle-icon" title="ë¯¸í•™ìŠµ"></i>ë¯¸í•™ìŠµ
        </label>
      </div>
      <div class="search-view-row">
        <div class="search-input-wrapper compact">
          <input type="text" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="searchInput" />
        </div>
        <div class="view-toggle">
          <button id="card-view-btn" class="active">ì¹´ë“œ ë³´ê¸°</button>
          <button id="table-view-btn">í…Œì´ë¸” ë³´ê¸°</button>
        </div>
      </div>
    </div>

    <div id="card-view">
      <div class="card-container" id="myword-cards"></div>
    </div>

    <div id="table-view" style="display: none;">
      <div class="word-table">
        <table>
          <thead>
            <tr>
              <th>ë‹¨ì–´</th>
              <th>ëœ»</th>
              <th>í’ˆì‚¬</th>
              <th>ì¶”ê°€ìœ í˜•</th>
              <th>ì¶”ê°€ì¼</th>
              <th>í•™ìŠµ ìƒíƒœ</th>
              <th>ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="myword-list"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let words = [];
    let ascending = false;  // ì´ˆê¸°: ìµœì‹ ìˆœ + ë‚´ë¦¼ì°¨ìˆœ
    let learnedSet = new Set();

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (!res.ok) throw new Error();
        const user = await res.json();
        localStorage.setItem('user_id', user.id);
        const userSpan = document.createElement('span');
        userSpan.textContent = `${user.email}ë‹˜`;
        document.querySelector('.nav-user')?.prepend(userSpan);
      } catch (err) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
      }

      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
          await fetch('/logout', { method: 'POST', credentials: 'include' });
        } catch {}
        localStorage.clear();
        window.location.href = 'login.html';
      });

      // ğŸ”½ ì •ë ¬ ë°©í–¥ ë²„íŠ¼ ì´ˆê¸° ì…‹íŒ…
      const dirBtn = document.getElementById('sortDirectionBtn');
      dirBtn.textContent = 'ë‚´ë¦¼ì°¨ìˆœ';
      dirBtn.classList.add('descending');

      const userId = localStorage.getItem('user_id');
      try {
        const res = await fetch(`/api/mywords?user_id=${userId}`);
        words = await res.json();
        const learnedRes = await fetch(`/api/learned?user_id=${userId}`);
        const learned = await learnedRes.json();
        learnedSet = new Set(learned);
        renderMyWords(words);

        // ğŸ”„ ì •ë ¬ ê¸°ì¤€ ë²„íŠ¼ í´ë¦­
        document.querySelectorAll('.sort-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // âœ… ê¸°ì¤€ë³„ ì •ë ¬ ë°©í–¥ ìë™ ì„¤ì •
            const selectedSort = btn.dataset.sort;
            if (selectedSort === 'recent') {
              ascending = false;
            } else {
              ascending = true;
            }

            dirBtn.textContent = ascending ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ';
            dirBtn.classList.toggle('ascending', ascending);
            dirBtn.classList.toggle('descending', !ascending);

            renderMyWords(words);
          });
        });

        // ğŸ”„ í•„í„° ì²´í¬ë°•ìŠ¤
        document.querySelectorAll('.filter-checkbox').forEach(cb => {
          cb.addEventListener('change', () => renderMyWords(words));
        });
      } catch (err) {
        console.error('ë‹¨ì–´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
        alert('ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      document.getElementById('card-view-btn').addEventListener('click', () => {
        document.getElementById('table-view').style.display = 'none';
        document.getElementById('card-view').style.display = 'block';
        document.getElementById('card-view-btn').classList.add('active');
        document.getElementById('table-view-btn').classList.remove('active');
      });

      document.getElementById('table-view-btn').addEventListener('click', () => {
        document.getElementById('card-view').style.display = 'none';
        document.getElementById('table-view').style.display = 'block';
        document.getElementById('table-view-btn').classList.add('active');
        document.getElementById('card-view-btn').classList.remove('active');
      });

      // ğŸ” ì˜¤ë¦„/ë‚´ë¦¼ì°¨ìˆœ ë²„íŠ¼ í´ë¦­
      dirBtn.addEventListener('click', () => {
        ascending = !ascending;
        dirBtn.textContent = ascending ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ';
        dirBtn.classList.toggle('ascending', ascending);
        dirBtn.classList.toggle('descending', !ascending);
        renderMyWords(words);
      });

      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', () => renderMyWords(words));
      }
    });


    function renderMyWords(wordList) {
      const tbody = document.getElementById('myword-list');
      const cardContainer = document.getElementById('myword-cards');
      tbody.innerHTML = '';
      cardContainer.innerHTML = '';
      const userId = localStorage.getItem('user_id');

      const sortValue = document.querySelector('.sort-btn.active')?.dataset.sort || 'recent';
      const checkedFilters = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);

      // í•„í„° ì¡°ê±´: OR ë°©ì‹ìœ¼ë¡œ í†µê³¼
      const filtered = wordList.filter(w => {
        const byType =
          (checkedFilters.includes('favorite') && w.added_by_favorite) ||
          (checkedFilters.includes('test')     && w.added_by_test) ||
          (checkedFilters.includes('game')     && w.added_by_game);

        if (checkedFilters.includes('learned')) {
          return !learnedSet?.has?.(w.word_id); // âœ… ë¯¸í•™ìŠµë§Œ
        } else {
          return byType; // âœ… ë¶„ë¥˜ í•„í„° ì¡°ê±´ ì¤‘ í•˜ë‚˜ë¼ë„
        }
      });

      // ì •ë ¬ ê¸°ì¤€
      if (sortValue === 'recent') {
        filtered.sort((a, b) => ascending
            ? new Date(a.added_at) - new Date(b.added_at)
            : new Date(b.added_at) - new Date(a.added_at));
      } else if (sortValue === 'alpha') {
        filtered.sort((a, b) => ascending
            ? a.word.localeCompare(b.word)
            : b.word.localeCompare(a.word));
      } else if (sortValue === 'part') {
        filtered.sort((a, b) => ascending
            ? a.part_of_speech.localeCompare(b.part_of_speech)
            : b.part_of_speech.localeCompare(a.part_of_speech));
      }

      // ì¶”ê°€ ìœ í˜• ë¬¸ìì—´ í‘œì‹œ
      function getAddedByLabels(word) {
        const labels = [];
        if (word.added_by_favorite) labels.push('ìˆ˜ë™ ì¶”ê°€');
        if (word.added_by_test)     labels.push('í…ŒìŠ¤íŠ¸ ì˜¤ë‹µ');
        if (word.added_by_game)     labels.push('ê²Œì„ ì˜¤ë‹µ');
        return labels.join(', ');
      }

      // ì¶”ê°€ ì•„ì´ì½˜ êµ¬ì„±
      function getAddedIcons(word) {
        const icons = [];
        if (word.added_by_favorite) icons.push(`<i class="fa-solid fa-star added-icon" title="ìˆ˜ë™ ì¶”ê°€"></i>`);
        if (word.added_by_test)     icons.push(`<i class="fa-solid fa-file-lines added-icon" title="í…ŒìŠ¤íŠ¸ ì˜¤ë‹µ"></i>`);
        if (word.added_by_game)     icons.push(`<i class="fa-solid fa-gamepad added-icon" title="ê²Œì„ ì˜¤ë‹µ"></i>`);
        return icons.join(' ');
      }

      const searchTerm = searchInput?.value.toLowerCase().trim() || '';
      const final = filtered.filter(word =>
        word.word.toLowerCase().includes(searchTerm) ||
        word.meaning.toLowerCase().includes(searchTerm)
      );

      // í…Œì´ë¸”í˜• ë Œë”ë§
      final.forEach(word => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${word.word}</td>
          <td>${word.meaning}</td>
          <td>${word.part_of_speech}</td>
          <td>${getAddedByLabels(word)}</td>
          <td>${new Date(word.added_at).toLocaleDateString()}</td>
          <td>
            <div class="toggle-wrapper" data-id="${word.word_id}" data-checked="false">
              <div class="toggle-bg"><div class="toggle-handle"></div></div>
              <i class="fa-solid fa-xmark toggle-icon"></i>
            </div>
          </td>
          <td><button class="study-btn delete-btn" data-id="${word.word_id}">ì‚­ì œ</button></td>
        `;
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            window.location.href = `seemore.html?wordId=${word.word_id}`;
          }
        });
        tbody.appendChild(tr);

        // ì¹´ë“œí˜• ë Œë”ë§
        const card = document.createElement('div');
        card.className = 'word-card';
        card.innerHTML = `
          <h3>${word.word}</h3>
          <div class="meaning">${word.meaning}</div>
          <div><em>${word.part_of_speech}</em></div>
          <div class="word-card-footer">
            <button class="study-btn delete-btn" data-id="${word.word_id}">ì‚­ì œ</button>
            <div class="added-icon-wrapper">${getAddedIcons(word)}</div>
          </div>
        `;
        card.style.cursor = 'pointer';
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            window.location.href = `seemore.html?wordId=${word.word_id}`;
          }
        });
        const toggle = document.createElement('div');
        toggle.className = 'toggle-wrapper float'; // float class ì¶”ê°€
        toggle.dataset.id = word.word_id;
        toggle.dataset.checked = 'false';
        toggle.innerHTML = `
          <div class="toggle-bg"><div class="toggle-handle"></div></div>
          <i class="fa-solid fa-xmark toggle-icon"></i>
        `;
        card.appendChild(toggle);

        cardContainer.appendChild(card);
      });

      //í•™ìŠµ ì™„ë£Œ ìƒíƒœ
      fetch(`/api/learned?user_id=${userId}`)
        .then(res => res.json())
        .then(data => {
          learnedSet = new Set(data);

          document.querySelectorAll('.toggle-wrapper').forEach(wrapper => {
            const wordId = Number(wrapper.dataset.id);
            const icon = wrapper.querySelector('.toggle-icon');
            const handle = wrapper.querySelector('.toggle-handle');
            const bg = wrapper.querySelector('.toggle-bg');

            const isChecked = learnedSet.has(wordId);
            wrapper.dataset.checked = isChecked.toString();
            icon.classList.toggle('fa-check', isChecked);
            icon.classList.toggle('fa-xmark', !isChecked);
            handle.style.left = isChecked ? '21px' : '1px';
            bg.style.backgroundColor = isChecked ? '#2ecc71' : '#ccc';

            wrapper.addEventListener('click', async (e) => {
              e.stopPropagation();
              const nowChecked = wrapper.dataset.checked === 'true';
              const method = nowChecked ? 'DELETE' : 'POST';
              const res = await fetch('/api/learned', {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, word_id: wordId })
              });
              if (res.ok) {
                const newChecked = !nowChecked;
                wrapper.dataset.checked = newChecked.toString();
                icon.classList.toggle('fa-check', newChecked);
                icon.classList.toggle('fa-xmark', !newChecked);
                handle.style.left = newChecked ? '21px' : '1px';
                bg.style.backgroundColor = newChecked ? '#2ecc71' : '#ccc';
              }
            });
          });
        })
        .catch(err => {
          console.error('í•™ìŠµ ì™„ë£Œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
        });

      // ì‚­ì œ ê¸°ëŠ¥
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const wordId = e.target.dataset.id;
          if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
              const res = await fetch(`/api/mywords`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: localStorage.getItem('user_id'), word_id: wordId })
              });

              if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
              alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
              words = words.filter(w => w.word_id !== Number(wordId));
              renderMyWords(words);
            } catch (err) {
              console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
              alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
          }
        });
      });
    }

    
    document.getElementById('hamburger')?.addEventListener('click', () => {
      document.querySelector('.sidebar')?.classList.toggle('show');
    });


  </script>
</body>
</html>

