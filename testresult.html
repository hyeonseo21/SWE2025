<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EnPick - í…ŒìŠ¤íŠ¸ ê²°ê³¼</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .result-wrapper {
      margin-left: 220px;
      padding: 80px 40px;
    }

    @media (max-width: 768px) {
      .result-wrapper {
        margin-left: 0;
        padding-top: 80px;
      }
    }

    .result-box {
      max-width: 700px;
      margin: auto;
      background: #f9f9ff;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    .wrong-list {
      margin-top: 24px;
    }

    .word-item {
      padding: 12px;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
    }

    .word-item.correct {
      border-color: #4caf50;
      background: #e8f5e9;
    }

    .word-item.wrong {
      border-color: #f44336;
      background: #ffebee;
    }

    .btn-row {
      margin-top: 32px;
      text-align: center;
    }

    .btn-row button {
      padding: 12px 20px;
      margin: 0 10px;
      border: none;
      background-color: #6c80ff;
      color: white;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    #summary ul {
      list-style-type: none;
      padding-left: 0;
      margin-left: 0;
    }

  </style>
</head>
<body>
  <nav class="nav-bar">
    <div class="nav-logo">
      <img src="assets/enpick-logo.png" alt="EnPick ë¡œê³ " />
      <h2>EnPick</h2>
    </div>
    <div class="nav-user">
      <a href="#" id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <div class="hamburger" id="hamburger">&#9776;</div>
  </nav>
  <div class="sidebar" id="sidebar">
    <a href="home.html" class="menu-item">í™ˆ</a>
    <a href="vocabulary.html" class="menu-item">ì „ì²´ ë‹¨ì–´ì¥</a>
    <a href="mywords.html" class="menu-item">My ë‹¨ì–´ì¥</a>
    <a href="study.html" class="menu-item">í•™ìŠµ</a>
    <a href="gamestart.html" class="menu-item">ë‹¨ì–´ ë¯¸ë‹ˆ ê²Œì„</a>
    <a href="teststart.html" class="menu-item active">í…ŒìŠ¤íŠ¸</a>
    <a href="#" class="menu-item">í†µê³„</a>
  </div>

  <div class="result-wrapper">
    <div class="result-box">
      <h2 id="resultTitle">ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
      <div id="summary"></div>
      <div class="wrong-list" id="resultList"></div>
      <div class="btn-row" id="retryButtons">
        <button onclick="retryWrong()">ì˜¤ë‹µ ë³µìŠµ í…ŒìŠ¤íŠ¸</button>
        <button onclick="showAnswers()">ì •ë‹µ í™•ì¸</button>
      </div>
      <div class="btn-row" id="gobackButtons">
        <button onclick="goMyWord()">Myë‹¨ì–´ì¥ìœ¼ë¡œ</button>
        <button onclick="goVocab()">ì „ì²´ ë‹¨ì–´ì¥ìœ¼ë¡œ</button>
        <button onclick="goHome()">í™ˆìœ¼ë¡œ</button>
      </div>
    </div>
  </div>

  <script>
    document.getElementById("hamburger")?.addEventListener("click", () => {
      document.getElementById("sidebar")?.classList.toggle("show");
    });

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (!res.ok) throw new Error();
        const user = await res.json();
        window.userId = user.id;

        const userSpan = document.createElement('span');
        userSpan.textContent = `${user.email}ë‹˜`;
        document.querySelector('.nav-user')?.prepend(userSpan);

        document.getElementById('logoutBtn')?.addEventListener('click', async () => {
          try {
            await fetch('/logout', {
              method: 'POST',
              credentials: 'include'
            });
          } catch (err) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', err);
          }

          localStorage.clear();
          window.location.href = 'login.html';
        });
      } catch (err) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
      }
      renderResult();
    });


    function renderResult() {
      const result = JSON.parse(localStorage.getItem("testResult")) || [];
      const source = localStorage.getItem("testSource") || 'test';
      const wrong = result.filter(r => !r.correct);
      const correctCount = result.filter(r => r.correct).length;
      const totalCount = result.length;
      const wrongCount = wrong.length;
      const accuracy = ((correctCount / totalCount) * 100).toFixed(2);
      const titleEl = document.getElementById("resultTitle");

      if (source === 'game') {
        titleEl.textContent = 'ğŸ® ê²Œì„ ê²°ê³¼';
      } else if (source === 'level') {
        titleEl.textContent = 'ğŸ“Š ë ˆë²¨ í…ŒìŠ¤íŠ¸ ê²°ê³¼';
      } else {
        titleEl.textContent = 'ğŸ—“ï¸ ë§¤ì¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼';
      }

      document.getElementById("summary").innerHTML = `
        ì´ ${result.length}ë¬¸ì œ ì¤‘ <b>${result.filter(r => r.correct).length}</b>ê°œ ì •ë‹µ (ì •ë‹µë¥ : <b>${accuracy}%<b>)
      `;

      fetch('/api/save-test-result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: window.userId,
          correctCount,
          wrongCount
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("ì €ì¥ ì‹¤íŒ¨");
        return fetch('/api/test-summary', { credentials: 'include' });
      })
      .then(res => res.json())
      .then(data => {
        const acc = data.accuracy?.toFixed(2) || '0.00';
        const total = data.correct_total + data.wrong_total;
        const extra = `
          <p>ğŸ“ˆ ëˆ„ì  ì •ë‹µë¥ : <b>${acc}%</b> (${data.correct_total}/${total})</p>
        `;
        document.getElementById("summary").innerHTML += extra;
      
        if (source === 'level') {
          const diffStats = {}; // {600: {correct: 0, total: 0}, ...}
          result.forEach(r => {
            const level = r.difficulty;
            if (!diffStats[level]) diffStats[level] = { correct: 0, total: 0 };
            diffStats[level].total++;
            if (r.correct) diffStats[level].correct++;
          });

          // ì •ë‹µë¥  ê³„ì‚° + ì¶œë ¥
          let lowestLevel = null;
          let summaryHtml = '<hr><p><b>ğŸ“˜ ë‚œì´ë„ë³„ ì •ë‹µë¥ </b></p><ul>';
          Object.keys(diffStats).sort().forEach(level => {
            const { correct, total } = diffStats[level];
            const rate = (correct / total * 100).toFixed(1);
            summaryHtml += `<li>${level} : ${rate}%</li>`;
            if (rate <= 70 && (lowestLevel === null || Number(level) < Number(lowestLevel))) {
              lowestLevel = level;
            }
          });
          summaryHtml += '</ul>';

          if (lowestLevel) {
            summaryHtml += `<p>ğŸ“Œ ì¶”ì²œ í•™ìŠµ ë‚œì´ë„: <b>${lowestLevel}</b></p>`;
          }

          document.getElementById("summary").innerHTML += summaryHtml;
        }
      });


      const container = document.getElementById("resultList");
      result.forEach(r => {
        const div = document.createElement("div");
        div.className = "word-item word-row " + (r.correct ? "correct" : "wrong");
        div.innerHTML = `
          ëœ»: ${r.meaning}<br/>
          ${r.correct ? "âœ… ì •ë‹µ" : `âŒ ì˜¤ë‹µ â†’ ì…ë ¥: <b>${r.userAnswer}</b>`}
        `;
        container.appendChild(div);

        const actualSource = (source === 'level' || source === 'daily') ? 'test' : source;
        if (!r.correct) {
          fetch('/api/mywords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: window.userId, word_id: r.word_id, 
              source: actualSource })
          });
        }
      });

      window.wrongList = wrong;

      if (wrong.length === 0) {
        document.getElementById("retryButtons").style.display = "none";
      }

      localStorage.removeItem("testSource");
    }

    function retryWrong() {
      const wrong = window.wrongList || [];
      if (wrong.length === 0) return alert('ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
      localStorage.setItem("retryWords", JSON.stringify(wrong.map(w => w.word_id)));
      location.href = `test.html?type=retry&count=${wrong.length}`;
    }

    function showAnswers() {
      const result = JSON.parse(localStorage.getItem("testResult")) || [];
      document.querySelectorAll(".word-row").forEach((row, index) => {
        const item = result[index];
        if (!item.correct) {
          const answerBox = document.createElement("div");
          answerBox.innerHTML = `<span style="color: green; font-weight: bold;">ì •ë‹µ: ${item.word}</span>`;
          row.appendChild(answerBox);
        }
      });
      event.target.disabled = true;
    }

    function goHome() {
      location.href = 'home.html';
    }

    function goVocab() {
      location.href = 'vocabulary.html';
    }

    function goMyWord() {
      location.href = 'mywords.html';
    }
  </script>
</body>
</html>
