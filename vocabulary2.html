<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TOEIC Vocabulary</title>
  <!-- ê¸°ë³¸ ìŠ¤íƒ€ì¼ì‹œíŠ¸ ë§í¬ -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/vocabulary.css" />
</head>
<body>

  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <nav class="nav-bar">
    <!-- ì¢Œì¸¡ ë¡œê³  -->
    <div class="nav-left">
      <img src="assets/enpick-logo.png" alt="EnPick ë¡œê³ " class="logo" />
      <h2>EnPick</h2>
    </div>

    <!-- ì¤‘ì•™ ê´€ë¦¬ì ì¸ì¦ ì˜ì—­ -->
    <div class="nav-center">
      <!-- ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ -->
      <div id="adminAuthForm" class="admin-auth-form" style="display: none;">
          <!--span class="lock-icon">ğŸ”’</span-->
          <input type="password" id="adminPasswordInput" placeholder="ğŸ”’ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
          <button id="adminAuthBtn">í™•ì¸</button>
      </div>

      <!-- ê´€ë¦¬ì ì¸ì¦ ë²„íŠ¼ -->
      <button id="adminToggleBtn" class="admin-btn">ê´€ë¦¬ì ë²„ì „</button>
    </div>

    <!-- ìš°ì¸¡ ë¡œê·¸ì•„ì›ƒ -->
    <div class="nav-right">
      <a href="#" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
  </nav>

  <!-- ì‚¬ì´ë“œë°” ë©”ë‰´ -->
  <div class="sidebar">
    <a href="home.html" class="menu-item">í™ˆ</a>
    <a href="vocabulary.html" class="menu-item active">ë‹¨ì–´ì¥</a>
    <a href="#" class="menu-item">í•™ìŠµ</a>
    <a href="#" class="menu-item">í…ŒìŠ¤íŠ¸</a>
    <a href="#" class="menu-item">í†µê³„</a>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
  <div class="main-content">
    <h1>ë‹¨ì–´ì¥</h1>

    <!-- ê²€ìƒ‰ ë° í•„í„° ê¸°ëŠ¥ -->
    <div class="search-section">
      <div class="search-box">
        <div class="search-input-wrapper">
          <input type="text" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="searchInput" />
        </div>
        <select id="filterType">
          <option value="all">ì „ì²´ í’ˆì‚¬</option>
          <option value="noun">ëª…ì‚¬</option>
          <option value="verb">ë™ì‚¬</option>
          <option value="adjective">í˜•ìš©ì‚¬</option>
          <option value="adverb">ë¶€ì‚¬</option>
        </select>
      </div>
    </div>

    <!-- ê´€ë¦¬ì ë‹¨ì–´ ì¶”ê°€ ì–‘ì‹ -->
    <div id="wordAddForm" style="display: none; margin-top: 2rem;">
      <h2>ğŸ“Œ ë‹¨ì–´ ì¶”ê°€</h2>
      <input type="text" id="addWord" placeholder="ë‹¨ì–´" />
      <input type="text" id="addPartOfSpeech" placeholder="í’ˆì‚¬" />
      <input type="text" id="addMeaning" placeholder="ì˜ë¯¸" />
      <input type="text" id="addSynonym" placeholder="ìœ ì˜ì–´" />
      <input type="text" id="addAntonym" placeholder="ë°˜ì˜ì–´" />
      <input type="text" id="addExampleEn" placeholder="ì˜ˆë¬¸ (ì˜ì–´)" />
      <input type="text" id="addExampleKo" placeholder="ì˜ˆë¬¸ (í•œê¸€)" />
      <button id="submitWordBtn">ì¶”ê°€í•˜ê¸°</button>
    </div>

    <!-- ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
    <div class="word-table">
      <table>
        <thead>
          <tr>
            <th>ë‹¨ì–´</th>
            <th>í’ˆì‚¬</th>
            <th>ì˜ë¯¸</th>
            <th>í•™ìŠµ ìƒíƒœ</th>
          </tr>
        </thead>
        <tbody id="wordTableBody">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </tbody>
      </table>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ -->
    <div class="pagination"></div>
  </div>

  <!-- ì£¼ìš” ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    let wordData = [];
    let filteredWords = [];
    let currentPage = 1;
    let isAdmin = false;
    const itemsPerPage = 20;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', async () => {
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
      isAdmin = localStorage.getItem('isAdmin') === 'true';
      document.getElementById('wordAddForm').style.display = isAdmin ? 'block' : 'none';

      const adminToggleBtn = document.getElementById('adminToggleBtn');
      const adminAuthForm = document.getElementById('adminAuthForm');
      const adminAuthBtn = document.getElementById('adminAuthBtn');

      // ê´€ë¦¬ì ì¸ì¦ í¼ í† ê¸€
      adminToggleBtn.addEventListener('click', () => {
        if (isAdmin) {
          // ì´ë¯¸ ê´€ë¦¬ìì¼ ê²½ìš° â†’ ë¡œê·¸ì•„ì›ƒ ì—¬ë¶€ ë¬»ê¸°
          const confirmLogout = confirm('ê´€ë¦¬ì ë²„ì „ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (confirmLogout) {
            localStorage.removeItem('isAdmin');
            location.reload(); // ê´€ë¦¬ì ê¶Œí•œ í•´ì œ í›„ ìƒˆë¡œê³ ì¹¨
          }
        } else {
          // ê´€ë¦¬ì ì¸ì¦ ì „ì¼ ê²½ìš° â†’ ì¸ì¦ì°½ ë³´ì´ê¸°
          adminAuthForm.classList.toggle('show');
          adminAuthForm.style.display = adminAuthForm.classList.contains('show') ? 'block' : 'none';
        }
      });
      

      // ê´€ë¦¬ì ì¸ì¦ ìš”ì²­
      adminAuthBtn.addEventListener('click', async () => {
        const password = document.getElementById('adminPasswordInput').value;

        const res = await fetch('http://localhost:3000/api/verify-admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const result = await res.json();
        if (res.ok && result.success) {
          alert('âœ… ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ');
          localStorage.setItem('isAdmin', 'true');
          location.reload();
        } else {
          alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤');
        }
      });

      // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ê´€ë¦¬ì ì¸ì¦ í•´ì œ í¬í•¨)
      document.querySelector('.logout-btn')?.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('isAdmin');
        window.location.href = 'login.html';
      });

      // ê´€ë¦¬ì ë‹¨ì–´ ì¶”ê°€ ì²˜ë¦¬
      document.getElementById('submitWordBtn')?.addEventListener('click', async () => {
        const word = document.getElementById('addWord').value.trim();
        const part = document.getElementById('addPartOfSpeech').value.trim();
        const meaning = document.getElementById('addMeaning').value.trim();
        const synonym = document.getElementById('addSynonym').value.trim() || '-';
        const antonym = document.getElementById('addAntonym').value.trim() || '-';
        const exEn = document.getElementById('addExampleEn').value.trim() || '-';
        const exKo = document.getElementById('addExampleKo').value.trim() || '-';

        if (!word || !part || !meaning) {
          alert('ë‹¨ì–´, í’ˆì‚¬, ì˜ë¯¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤!');
          return;
        }

        const res = await fetch('http://localhost:3000/api/add-word', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ word, part_of_speech: part, meaning, synonym, antonym, example_en: exEn, example_ko: exKo })
        });

        const result = await res.json();
        if (res.ok && result.success) {
          alert('âœ… ë‹¨ì–´ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
          location.reload();
        } else {
          alert(`âŒ ì¶”ê°€ ì‹¤íŒ¨: ${result.error}`);
        }
      });

      // DBì—ì„œ ë‹¨ì–´ ë¶ˆëŸ¬ì˜¤ê¸°
      try {
        const response = await fetch('http://localhost:3000/api/words');
        wordData = await response.json();
        filteredWords = [...wordData];
        displayPage(currentPage);
      } catch (error) {
        console.error('âŒ ë‹¨ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        document.getElementById('wordTableBody').innerHTML =
          '<tr><td colspan="4">ë‹¨ì–´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }

      // ê²€ìƒ‰ ì´ë²¤íŠ¸ ì„¤ì •
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filterType = document.getElementById('filterType').value;
        filteredWords = wordData.filter(word => {
          const matchesSearch = word.word.toLowerCase().includes(searchTerm) || word.meaning.toLowerCase().includes(searchTerm);
          const matchesFilter = filterType === 'all' || word.part_of_speech === filterType;
          return matchesSearch && matchesFilter;
        });
        currentPage = 1;
        displayPage(currentPage);
      });

      // í’ˆì‚¬ í•„í„°ë§ ì„¤ì •
      document.getElementById('filterType').addEventListener('change', (e) => {
        const filterValue = e.target.value;
        const searchTerm = searchInput.value.toLowerCase();
        filteredWords = wordData.filter(word => {
          const matchesSearch = word.word.toLowerCase().includes(searchTerm) || word.meaning.toLowerCase().includes(searchTerm);
          const matchesFilter = filterValue === 'all' || word.part_of_speech === filterValue;
          return matchesSearch && matchesFilter;
        });
        currentPage = 1;
        displayPage(currentPage);
      });
    });

    // ë‹¨ì–´ í–‰ ì¶œë ¥
    function displayWords(words) {
      const tableBody = document.getElementById('wordTableBody');
      tableBody.innerHTML = '';
      words.forEach(word => {
        const row = createWordRow(word);
        tableBody.appendChild(row);
      });
    }

    // í˜ì´ì§€ë³„ ë‹¨ì–´ ì¶œë ¥
    function displayPage(page) {
      currentPage = page;
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      displayWords(filteredWords.slice(start, end));
      updatePagination(page, Math.ceil(filteredWords.length / itemsPerPage));
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ UI ìƒì„±
    function updatePagination(currentPage, totalPages) {
      const pagination = document.querySelector('.pagination');
      pagination.innerHTML = '';

      const prevButton = document.createElement('button');
      prevButton.textContent = 'âŸ¨';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => displayPage(currentPage - 1));
      pagination.appendChild(prevButton);

      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (startPage > 1) {
        pagination.appendChild(createPageButton(1));
        if (startPage > 2) pagination.appendChild(createEllipsis());
      }

      for (let i = startPage; i <= endPage; i++) {
        pagination.appendChild(createPageButton(i));
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) pagination.appendChild(createEllipsis());
        pagination.appendChild(createPageButton(totalPages));
      }

      const nextButton = document.createElement('button');
      nextButton.textContent = 'âŸ©';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => displayPage(currentPage + 1));
      pagination.appendChild(nextButton);
    }

    function createPageButton(pageNum) {
      const button = document.createElement('button');
      button.textContent = pageNum;
      button.classList.toggle('active', pageNum === currentPage);
      button.addEventListener('click', () => displayPage(pageNum));
      return button;
    }

    function createEllipsis() {
      const span = document.createElement('span');
      span.textContent = '...';
      span.style.margin = '0 8px';
      return span;
    }

    // ë‹¨ì–´ í–‰ ìƒì„± + ì‚­ì œ ë²„íŠ¼ + ìˆ˜ì • ë²„íŠ¼ (ê´€ë¦¬ìë§Œ í‘œì‹œ)
    function createWordRow(word) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${word.word}</td>
        <td>${word.part_of_speech}</td>
        <td>${word.meaning}</td>
        <td>
          ë¯¸í•™ìŠµ
          ${isAdmin ? `
          <button class="delete-btn" data-word="${word.word}">ğŸ—‘ï¸</button>
          <button class="edit-btn" data-word="${word.word}">âœï¸</button>
          ` : ''}
        </td>
      `;
    
      // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
      if (isAdmin) {
        const deleteBtn = row.querySelector('.delete-btn');
        deleteBtn?.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (!confirm(`'${word.word}'ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
    
          const res = await fetch('http://localhost:3000/api/delete-word', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ word: word.word })
          });
    
          const result = await res.json();
          if (res.ok && result.success) {
            alert('ì‚­ì œ ì™„ë£Œ');
            location.reload();
          } else {
            alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.error}`);
          }
        });
    
        // âœï¸ ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
        const editBtn = row.querySelector('.edit-btn');
        editBtn?.addEventListener('click', (e) => {
          e.stopPropagation(); // ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™ ë°©ì§€
    
          // ê¸°ì¡´ ìˆ˜ì • í¼ ì œê±°
          const existingForm = document.querySelector('.edit-form-row');
          if (existingForm) existingForm.remove();
    
          // ìˆ˜ì • í¼ ì¶”ê°€
          const editRow = document.createElement('tr');
          editRow.classList.add('edit-form-row');
          editRow.innerHTML = `
            <td colspan="4">
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="editWord" value="${word.word}" disabled />
                <input type="text" id="editPartOfSpeech" value="${word.part_of_speech}" />
                <input type="text" id="editMeaning" value="${word.meaning}" />
                <input type="text" id="editSynonym" value="${word.synonym || '-'}" />
                <input type="text" id="editAntonym" value="${word.antonym || '-'}" />
                <input type="text" id="editExampleEn" value="${word.example_en || '-'}" />
                <input type="text" id="editExampleKo" value="${word.example_ko || '-'}" />
                <button id="confirmEditBtn">ìˆ˜ì • ì™„ë£Œ</button>
              </div>
            </td>
          `;
          row.after(editRow);
    
          // ìˆ˜ì • ì™„ë£Œ ì´ë²¤íŠ¸
          document.getElementById('confirmEditBtn').addEventListener('click', async () => {
            const updated = {
              word: word.word,
              part_of_speech: document.getElementById('editPartOfSpeech').value.trim(),
              meaning: document.getElementById('editMeaning').value.trim(),
              synonym: document.getElementById('editSynonym').value.trim() || '-',
              antonym: document.getElementById('editAntonym').value.trim() || '-',
              example_en: document.getElementById('editExampleEn').value.trim() || '-',
              example_ko: document.getElementById('editExampleKo').value.trim() || '-',
            };
    
            const res = await fetch('http://localhost:3000/api/update-word', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(updated)
            });
    
            const result = await res.json();
            if (res.ok && result.success) {
              alert('âœ… ìˆ˜ì • ì™„ë£Œ!');
              location.reload();
            } else {
              alert(`âŒ ìˆ˜ì • ì‹¤íŒ¨: ${result.error}`);
            }
          });
        });
      }
    
      // ë‹¨ì–´ í´ë¦­ ì‹œ ìƒì„¸í˜ì´ì§€ ì´ë™
      row.addEventListener('click', function (e) {
        if (
          e.target.classList.contains('delete-btn') ||
          e.target.classList.contains('edit-btn')
        ) return;
    
        window.location.href = `seemore.html?word=${encodeURIComponent(word.word)}`;
      });
    
      return row;
    }
    

  </script>
</body>
</html>
